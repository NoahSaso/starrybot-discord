<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Codevember 2021 - 14 - Letter</title>
<meta name="viewport" content="initial-scale=1, maximum-scale=1" />
<link href="styles/styles.css" rel="stylesheet" />
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Arvo&display=swap" rel="stylesheet" />
</head>
<body>


<script type="module">



import {
  scene,
  controls,
  renderer,
  addUpdate,
  addResize,
  resize,
  camera,
} from "./modules/renderer.js";
import {
  Raycaster,
  Vector2,
  Matrix4,
  Mesh,
  PlaneBufferGeometry,
  MeshNormalMaterial,
} from "./third_party/three.module.js";
import { Distort } from "./14/Distort.js";
import { GLTFLoader } from "./third_party/GLTFLoader.js";
import { mergeGeometries } from "./modules/Geometry.js";
import { Letter } from "./14/Letter.js";
import { Post } from "./14/post.js";
// import { capture } from "../modules/capture.js";
import "./modules/konami.js";

const post = new Post(renderer);

renderer.setClearColor(0x101010, 1);

const letter = new Letter("Arvo");
letter.generate("pamber");

const s = 1;
const scale = new Matrix4().makeScale(s, s, s);
letter.mc.applyMatrix4(scale);

let distort;

async function loadSuzanne() {
  return new Promise((resolve, reject) => {
    const loader = new GLTFLoader();
    loader.load("../assets/suzanne.glb", (scene) => {
      const suzanneGeo = scene.scenes[0].children[0].geometry;
      const mat = new Matrix4().makeRotationX(-Math.PI / 2);
      suzanneGeo.applyMatrix4(mat);
      const s = 0.4;
      const scale = new Matrix4().makeScale(s, s, s);
      suzanneGeo.applyMatrix4(scale);
      resolve(suzanneGeo);
    });
  });
}

function init(geo) {
  distort = new Distort(geo);
  scene.add(distort.group);
  initEvents();
  render();
}

const raycaster = new Raycaster();
const mouse = new Vector2(100, 100);
const plane = new Mesh(
  new PlaneBufferGeometry(400, 400),
  new MeshNormalMaterial()
);
plane.visible = false;
scene.add(plane);

function hitPoint() {
  raycaster.setFromCamera(mouse, camera);
  const intersects = raycaster.intersectObject(plane);

  point = null;
  if (intersects.length) {
    point = intersects[0].point;
  }
}

function onMouseMove(event) {
  mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
  mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
  hitPoint();
}

let changed = false;
function initEvents() {
  window.addEventListener("pointermove", onMouseMove, false);

  controls.addEventListener("change", (e) => {
    changed = true;
  });

  window.addEventListener("pointerdown", (e) => (changed = false));

  window.addEventListener("konami-code", async (e) => {
    const suzanneGeo = await loadSuzanne();
    distort.objectMesh.geometry = suzanneGeo;
  });

  window.addEventListener("click", (e) => {
    mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
    mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
    hitPoint();

    if (point && !changed) {
      distort.addImpulse(point);
    }
  });

  window.addEventListener("keydown", (e) => {
    if (
      (e.keyCode >= 97 && e.keyCode <= 122) ||
      (e.keyCode >= 48 && e.keyCode <= 57) ||
      (e.keyCode >= 65 && e.keyCode <= 90)
    ) {
      letter.generate(String.fromCharCode(e.keyCode));
    }
    if (e.code === "Space") {
      if (point) {
        running = !running;
      }
    }
  });
}

let point;
let running = true;

camera.position.set(0, 0, 2);
camera.lookAt(scene.position);

function render() {
  plane.lookAt(camera.position);

  if (running) {
    distort.update(0.16);
  }

  // renderer.render(scene, camera);
  post.render(scene, camera);
  // capture(renderer.domElement);
  renderer.setAnimationLoop(render);
}

function myResize(w, h) {
  post.setSize(w, h);
}
addResize(myResize);

resize();

init(letter.mc);

let x = Math.random() - 0.5
let y = Math.random() - 0.5
setInterval( ()=>{  distort.addImpulse(new Vector2(x,y)) },5000);



</script>
</html>
